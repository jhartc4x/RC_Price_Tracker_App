{% extends "base.html" %}
{% block title %}Dashboard | Royal Caribbean Price Companion{% endblock %}
{% block content %}
<section class="hero-banner">
  <div>
    <span class="eyebrow">Price Command Center</span>
    <h1>Your Cruise Dashboard</h1>
    <p>Prioritized overview for pricing actions, savings opportunities, and current system status.</p>

    <div class="action-row" style="margin-top: 14px;">
      <form action="{{ url_for('run_now') }}" method="post" class="run-form">
        <select id="module" name="module" aria-label="Select Module">
          <option value="all">Run All Checks</option>
          <option value="cruise">Cruise Fares Only</option>
          <option value="addons">Add-ons Only</option>
          <option value="casino">Casino Offers Only</option>
        </select>
        <button type="submit" class="btn btn-primary">Run Now</button>
      </form>
      <a class="btn btn-secondary" href="{{ url_for('settings_page') }}">Settings</a>
    </div>
  </div>

  <aside class="run-status" data-run-status>
    <h3>System Status</h3>
    <div id="run-status-value" class="status-value">{{ run_state.status|title }}</div>
    <p id="run-status-meta" class="meta">
      Module: {{ 'All Systems' if run_state.module == 'all' else run_state.module|title }}
      {% if run_state.started_at %} | Started: {{ run_state.started_at|truncate(16, True, '') }}{% endif %}
    </p>
    <p id="run-status-message" class="meta" style="margin-top: 8px; opacity: 1;">{{ run_state.message }}</p>
  </aside>
</section>

<section class="metrics-grid">
  <article class="metric"><span>Booked Cruises</span><strong>{{ booked_cruises|length }}</strong></article>
  <article class="metric"><span>Watchlist Items</span><strong>{{ watchlist_cruises|length }}</strong></article>
  <article class="metric"><span>Price Records</span><strong>{{ metrics.price_records }}</strong></article>
  <article class="metric"><span>Active Alerts</span><strong>{{ metrics.alerts_sent }}</strong></article>
</section>

<section class="section-block dashboard-layout">
  <div style="display:grid; gap: 12px;">
    <article class="panel">
      <div class="section-head" style="margin-bottom: 8px;">
        <div>
          <h2>What needs attention</h2>
          <p>Top-level signal only</p>
        </div>
      </div>
      <ul class="focus-list">
        <li><span>Booked sailings currently tracked</span><strong>{{ booked_cruises|length }}</strong></li>
        <li><span>Watchlist items with latest pricing</span><strong>{{ watchlist_cruises|length }}</strong></li>
        <li><span>Casino offers currently active</span><strong>{{ recent_offers|length }}</strong></li>
      </ul>
    </article>

    <article class="panel">
      <div class="section-head" style="margin-bottom: 8px;">
        <div>
          <h2>Watchlist opportunities</h2>
          <p>Sorted by potential savings</p>
        </div>
      </div>
      {% if watchlist_cruises %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cruise</th>
              <th>Paid</th>
              <th>Current</th>
              <th>Delta</th>
            </tr>
          </thead>
          <tbody>
            {% for watch in watchlist_cruises[:6] %}
            {% set current = watch.latest_cruise_price if watch.latest_cruise_price is not none else 0 %}
            {% set paid = watch.paid_price or 0 %}
            {% set delta = paid - current if current else 0 %}
            <tr>
              <td>{{ watch.label }}</td>
              <td>${{ "%.2f"|format(paid) }}</td>
              <td>{% if watch.latest_cruise_price is not none %}${{ "%.2f"|format(current) }}{% else %}-{% endif %}</td>
              <td>
                {% if delta > 0 %}
                <span style="color: var(--ok); font-weight: 700;">-${{ "%.2f"|format(delta) }}</span>
                {% else %}
                <span class="meta">—</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><p>No watchlist items yet. Add one in settings.</p></div>
      {% endif %}
    </article>
  </div>

  <div style="display:grid; gap: 12px;">
    <article class="panel">
      <div class="section-head" style="margin-bottom: 8px;">
        <div>
          <h2>Recent casino offers</h2>
          <p>Condensed list</p>
        </div>
        {% if recent_offers %}
        <button class="btn btn-secondary" type="button" data-open-modal="all-offers-modal">View all</button>
        {% endif %}
      </div>

      {% if recent_offers %}
      <div class="offer-list">
        {% for offer in recent_offers[:7] %}
        <article class="offer-row">
          <div>
            <strong>{{ offer.offer_name }}</strong>
            <p>{{ offer.offer_code }} • {{ offer.account_username }}</p>
          </div>
          <span class="offer-date">{{ offer.expiry_date or 'N/A' }}</span>
        </article>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state"><p>No offers found yet.</p></div>
      {% endif %}
    </article>

    <article class="panel">
      <div class="section-head" style="margin-bottom: 8px;">
        <div>
          <h2>Booked cruises</h2>
          <p>Quick roster</p>
        </div>
      </div>
      {% if booked_cruises %}
      <div class="table-wrap">
        <table>
          <thead><tr><th>Ship</th><th>Sail Date</th><th>Stateroom</th><th>Alerts</th></tr></thead>
          <tbody>
            {% for cruise in booked_cruises[:8] %}
            <tr>
              <td>{{ cruise.ship_name }}</td>
              <td>{{ cruise.sail_date or '-' }}</td>
              <td>{{ cruise.stateroom_number or '-' }}</td>
              <td>{{ cruise.addon_alert_count }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><p>No booked cruises found.</p></div>
      {% endif %}
    </article>
  </div>
</section>

<div id="all-offers-modal" class="modal" hidden>
  <div class="modal-backdrop" data-close-modal></div>
  <div class="modal-dialog">
    <div class="section-head inline-actions">
      <h2>All Casino Offers</h2>
      <button type="button" class="btn btn-ghost" data-close-modal>Close</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Offer</th><th>Code</th><th>Account</th><th>Expires</th></tr></thead>
        <tbody>
          {% for offer in recent_offers %}
          <tr>
            <td>{{ offer.offer_name }}</td>
            <td>{{ offer.offer_code }}</td>
            <td>{{ offer.account_username }}</td>
            <td>{{ offer.expiry_date or 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<footer class="page-footer"><p>RC Price Companion</p></footer>
{% endblock %}
